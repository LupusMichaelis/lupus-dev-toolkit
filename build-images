#!/usr/bin/env bash

set -euo pipefail

if [[ -v DEBUG && ! -z "$DEBUG" ]]
then
	set -x
fi

docker-sign()
{
	local -r name="$1"
	local -r version="$2"

	docker trust sign "lupusmichaelis/$name:$version"
}

yq()
{
	docker run --rm -i -v "${PWD}":/workdir mikefarah/yq "$@"
}

export COMPOSE_DOCKER_CLI_BUILD=1
export DOCKER_BUILDKIT=1

docker-compose -f builder.docker-compose.yml build --parallel --progress plain \
	&& cat builder.docker-compose.yml \
		| yq e '.services.*.image' - \
		| xargs -n 1 docker trust sign --local \
	&& docker-compose -f builder.docker-compose.yml push
